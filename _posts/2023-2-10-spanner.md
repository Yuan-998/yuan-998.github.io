---
layout: post
title: Google Spanner
subtitle: study notes of Google Spanner
cover-img: "../assets/img/spanner/cover.png"
tags: [Distributed System]
readtime: true
---

## Spanner's recipe
- state machine replication within a shard
- Two-phase locking for serialization
- Two-phase commit for distributed transactions or cross-shard transactions
- Multi-version database systems
- Snapshot isolation

## Key idea: Synchronize snapshots
External Consistency: Commit order respects global wall-time order

## TrueTime
`TrueTime.now()` returns an time interval `[TT.now().earliest(), TT.now().lastest()]`

### Commit Wait
In 2PL, the transaction first acquires locks and the release the locks. The timestamp `s` is chosen between the time of acquiring locks (T<sub>a</sub>) and the time of releasing locks T<sub>r</sub> as the timestamp of the transaction. The timestamp `s` should satisfy `T`<sub>`a`</sub>`.lastest() < s < T`<sub>`r`</sub>`.eariliest()`

## Questions
[Reference](http://nil.csail.mit.edu/6.824/2021/papers/spanner-faq.txt)

### How does external consistency relate to linearizability and serializability?

External consistency seems to be equivalent to linearizability, but applied to entire transactions rather than individual reads and writes. External consistency also seems equivalent to strict serializability, which is serializability with the added constraint that the equivalent serial order must obey real time order. The critical property is that if transaction T1 completes, and then (afterwards in real time) transaction T2 starts, T2 must see T1's writes.

### Why is external consistency desirable?

Suppose Hatshepsut changes the password on an account shared by her workgroup, via a web server in a datacenter in San Jose. She whispers the new password over the cubicle wall to her colleage Cassandra. Cassandra logs into the account via a web server in a different datacenter, in San Mateo. External consistency guarantees that Cassandra will observe the change to the password, and not, for example, see a stale replica.

### What is the pupose of Spanner's commit wait?

Commit wait ensures that a read/write transaction does not complete until the time in its timestamp is guaranteed to have passed. That means that a read/only transaction that starts after the read/write transaction completes is guaranteed to have a higher timestamp, and thus to see the read/write transaction's writes. This helps fulfil the guarantee of external consistency: if T1 completes before T2 starts, T2 will come after T1 in the equivalent serial order (i.e. T2 will see T1's writes).