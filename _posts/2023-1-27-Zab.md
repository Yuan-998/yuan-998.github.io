---
layout: post
title: Zab
subtitle: Some questions regarding Zab
tags: [Distributed System]
readtime: true
---

## Zab Model
- Primary-backup replica roles
  - Primary-backup
    - [Formal definition](https://www.cs.cornell.edu/fbs/publications/DSbook.c8.pdf) of Primary-backup
  - Replicated state machine
    - All replicas execute all operations
    - If same start state & same opertions & same order & deterministic ==> same end state
    - *Ops* are transferred between replicas not the state
- Any replica can act as Primary
  - At most one active at a time
- Works with epochs
- State changes are called transactions (TXs)
- TXs are identified by an epoch and a counter pair (zxid)
  - zxid (64-bit long integer) = epoch (high 32 bits) | counter (long 32 bits)
    - `epoch` $\approx$ `term` in raft
    - `counter` $\approx$ `index` in raft
- Ordering as follows:
  - zxid<sub>1</sub> < zxid<sub>2</sub> iff:
    - zxid<sub>1</sub>.epoch < zxid<sub>2</sub>.epoch
    - zxid<sub>1</sub>.epoch = zxid<sub>2</sub>.epoch && zxid<sub>1</sub>.counter < zxid<sub>2</sub>.counter

## Workflow
### Discovery
`(Follower) Send last epoch number e to l` <a>&rarr;</a> `(Leader) Upon receiving messages from Quorum, propose new epch e' s.t. e' > e for all messages received in Quorum` <a>&rarr;</a> `(Follower) Upon receiving e', if e' > e, then e' = e. Reply with ACK with the highest zxid` <a>&rarr;</a> `(Leader) Upon receiving ACKs from Quorum, select highest zxid. Receiving missing TXs from followers (s.t. zxid' < zxid)`
### Synchronization
`(Leader) Propose NEWLEADER and send highest zxid selected` <a>&rarr;</a> `(Follower) Set l as the new leader. Accept TXs with zxid' < zxid. Reply with ACK` <a>&rarr;</a> `(Leader) Upon receiving ACKs from Quorum, send COMMIT message to all followers` <a>&rarr;</a> `(Follower) Upon receiving COMMIT, deliver the previously accepted TXs`
### Broadcast
`(Leader) Increment counter and propose TXs. Now zxid' > previous largest zxid` <a>&rarr;</a> `(Follower) Accept the TXs and reply with ACK` <a>&rarr;</a> `(Leader) Upon receiving ACKs from Quorum, send COMMIT message to all followers` <a>&rarr;</a> `(Follower) Upon receiving COMMIT, deliver the TXs`

![zab](../assets/img/zab/zab.png)


## Comparsion with Raft
- raft.term $\approx$ zab.epoch
- raft: leader sends heartbeat to followers
  zab: followers send heartbeat to leader